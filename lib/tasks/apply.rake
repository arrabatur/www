namespace :apply do
  task create: :environment do
    apply_params = {
      first_name: 'SÃ©bastien',
      last_name: 'Saunier',
      email: 'seb@lewagon.org',
      phone: '+33600000000',
      age: 30 + rand(10),
      motivation: 'Lorem ipsum dolor sit amet, consectetur adipisicing elit. Sequi quas assumenda ea deleniti sint necessitatibus quibusdam omnis optio molestiae non ratione laudantium dignissimos repudiandae praesentium reiciendis, qui ipsum blanditiis fugit!',
      source: 'Testing from rake'
    }

    apply = Apply.new(apply_params)
    card = PushToTrelloRunner.new(apply).run
    PushStudentToCrmRunner.new(card, apply).run

    puts "Created card for #{apply.email}"
  end

  task send_all_to_kitt: :environment do
    puts "=== Sending #{Apply.count} appications ==="
    i = 1
    t = (Apply.count / 1000) + 1
    Apply.find_in_batches do |applies|
      puts "#{i} / #{t}"
      applies.each do |apply|
        PushApplyToKittRunner.new(apply).run
      end
      i += 1
    end
    puts '=== Done! ==='
  end

  task migrate: :environment do
    kitt_cities = [{ 'london' => { id: 9, camps: [90, 192, 77, 130, 111, 72, 172, 202, 149] } }, { 'recife' => { id: 29, camps: [194] } }, { 'beirut' => { id: 16, camps: [48, 15] } }, { 'brussels' => { id: 18, camps: [33, 81, 143, 190, 187, 214, 10, 45, 7, 18, 13, 110] } }, { 'lille' => { id: 17, camps: [167, 42, 200, 92, 107, 123, 71, 75, 14, 32, 155, 157] } }, { 'copenhagen' => { id: 10, camps: [152, 169, 91, 108, 197, 198, 49, 78] } }, { 'chengdu' => { id: 22, camps: [189, 125, 162] } }, { 'florianopolis' => { id: 23, camps: [] } }, { 'tokyo' => { id: 21, camps: [177, 213, 104, 118, 133] } }, { 'amsterdam' => { id: 12, camps: [166, 36, 74, 21, 97, 114, 144] } }, { 'melbourne' => { id: 28, camps: [180, 191] } }, { 'bali' => { id: 24, camps: [173, 203, 209] } }, { 'montreal' => { id: 2, camps: [158, 98, 208, 115, 146] } }, { 'belo-horizonte' => { id: 5, camps: [199, 174] } }, { 'paris' => { id: 19, camps: [183, 171, 196, 84, 179, 1, 16, 19, 34, 46, 94, 102, 2, 4, 5, 8, 9, 11, 12, 112, 153, 79, 147] } }, { 'shanghai' => { id: 3, camps: [206, 163, 113, 96, 127, 161] } }, { 'milan' => { id: 26, camps: [201, 175] } }, { 'rio' => { id: 4, camps: [86, 120, 182, 207, 160] } }, { 'sao-paulo' => { id: 6, camps: [186, 82, 50, 99, 119, 156] } }, { 'lisbon' => { id: 13, camps: [210, 211, 44, 176, 212, 103, 85, 145, 122] } }, { 'nantes' => { id: 11, camps: [188, 43, 83, 95, 150, 116] } }, { 'aix-marseille' => { id: 14, camps: [168, 185, 105, 128, 73, 142, 31, 89] } }, { 'lyon' => { id: 8, camps: [195, 178, 124, 88, 109, 159] } }, { 'berlin' => { id: 20, camps: [101, 129, 164, 151, 205] } }, { 'bordeaux' => { id: 15, camps: [193, 184, 87, 17, 20, 106, 47, 76, 148, 121] } }, { 'sydney' => { id: 27, camps: [181] } }, { 'budapest' => { id: 25, camps: [170] } }, { 'casablanca' => { id: 30, camps: [204] } }, { 'barcelona' => { id: 7, camps: [216, 165, 80, 93, 100, 132, 215, 154] } }]
    alumni_batches = [[157, nil], [156, nil], [155, nil], [154, nil], [153, '134'], [152, nil], [151, nil], [150, nil], [149, '135'], [148, nil], [147, '136'], [146, nil], [145, nil], [144, nil], [143, '129'], [142, '124'], [141, nil], [140, '125'], [139, '105'], [138, '126'], [137, '119'], [136, '131'], [135, nil], [134, '137'], [133, nil], [132, '128'], [131, '123'], [130, '101'], [129, '130'], [128, '117'], [127, '120'], [126, '132'], [125, '114'], [124, '116'], [123, '121'], [122, '118'], [121, nil], [120, '122'], [119, '112'], [118, '107'], [117, '99'], [115, '113'], [114, '110'], [113, '106'], [112, '98'], [111, '94'], [110, '104'], [109, ''], [108, '96'], [107, '103'], [106, '88'], [105, '97'], [104, '90'], [103, '111'], [102, '108'], [101, '109'], [100, '102'], [99, '78'], [98, '80'], [97, '76'], [96, '100'], [95, '82'], [94, '79'], [93, '89'], [92, '81'], [91, '95'], [90, '77'], [89, '75'], [88, '93'], [87, '69'], [86, '86'], [85, '71'], [84, '92'], [83, '72'], [82, '87'], [81, '58'], [80, '84'], [79, '65'], [78, '83'], [77, '74'], [76, '85'], [75, '73'], [74, '63'], [73, '68'], [72, '67'], [71, '64'], [70, '61'], [69, '62'], [68, '59'], [67, '54'], [66, '55'], [65, '60'], [64, '91'], [63, '66'], [62, '53'], [61, '70'], [60, '56'], [59, '57'], [58, '50'], [56, '115'], [55, '49'], [54, '44'], [53, '42'], [52, '46'], [51, '51'], [50, '45'], [49, '41'], [47, '48'], [46, '47'], [45, '52'], [44, '38'], [43, '40'], [42, '37'], [41, '25'], [40, '34'], [39, '43'], [38, '36'], [37, '33'], [36, '27'], [35, ''], [34, '39'], [33, '26'], [32, '31'], [31, '20'], [29, '29'], [28, ''], [27, '35'], [26, '28'], [25, '30'], [24, '24'], [23, '23'], [22, '32'], [21, '22'], [20, '21'], [19, '19'], [18, '18'], [17, '17'], [16, '16'], [15, '15'], [14, '14'], [13, '13'], [12, '12'], [11, '11'], [10, '10'], [9, '9'], [8, '8'], [7, '7'], [6, '6'], [5, '5'], [4, '4'], [3, '3'], [2, '2'], [1, '1']]
    kitt_camps = [[33, "23"], [81, "45"], [143, "96"], [90, "54"], [199, nil], [167, "116"], [152, "104"], [166, "126"], [180, "135"], [183, "1"], [216, nil], [165, "129"], [158, "125"], [210, nil], [169, "118"], [91, "55"], [108, "69"], [42, "26"], [181, "136"], [168, "117"], [190, nil], [211, nil], [192, nil], [197, nil], [44, "28"], [189, nil], [185, nil], [193, nil], [195, nil], [194, nil], [186, nil], [171, "120"], [184, nil], [174, "115"], [200, nil], [198, nil], [191, nil], [187, nil], [214, nil], [170, "119"], [77, "41"], [130, "93"], [92, "56"], [107, "68"], [173, "128"], [196, nil], [123, "87"], [176, "122"], [80, "44"], [93, "57"], [206, nil], [87, "51"], [10, "9"], [84, "48"], [82, "46"], [212, nil], [179, "134"], [111, "74"], [103, "71"], [72, "36"], [105, "66"], [17, "16"], [20, "19"], [172, "123"], [106, "67"], [1, "2"], [16, "15"], [19, "18"], [50, "34"], [177, "132"], [98, "63"], [34, "24"], [46, "30"], [94, "59"], [102, "70"], [2, "3"], [4, "4"], [163, "130"], [113, "76"], [101, "65"], [202, nil], [204, nil], [188, nil], [45, "29"], [47, "31"], [86, "50"], [120, "84"], [99, "64"], [43, "27"], [36, "25"], [128, "91"], [178, "121"], [124, "82"], [129, "92"], [182, "137"], [164, "124"], [207, nil], [48, "32"], [49, "33"], [78, "42"], [71, "35"], [75, "39"], [74, "38"], [76, "40"], [73, "37"], [149, "103"], [7, "7"], [18, "17"], [5, "5"], [8, "6"], [9, "8"], [11, "10"], [12, "11"], [203, nil], [142, "89"], [151, "111"], [205, nil], [6, "staff"], [13, "12"], [14, "13"], [32, "22"], [21, "20"], [112, "83"], [31, "21"], [208, nil], [153, "101"], [209, nil], [213, nil], [15, "14"], [201, nil], [88, "52"], [104, "58"], [110, "73"], [97, "62"], [114, "80"], [115, "77"], [79, "43"], [96, "61"], [100, "75"], [83, "47"], [95, "60"], [85, "49"], [89, "53"], [109, "72"], [145, "97"], [118, "78"], [148, "102"], [150, "107"], [146, "98"], [125, "88"], [147, "100"], [144, "99"], [121, "85"], [127, "90"], [119, "81"], [132, "95"], [116, "79"], [122, "86"], [133, "94"], [155, "105"], [157, "108"], [160, "110"], [161, "112"], [156, "106"], [162, "114"], [175, "131"], [215, nil], [154, "113"], [159, "109"]]

    Apply.where("created_at < ?", Date.parse('23/11/2017')).each do |apply|
      alumni_batch = alumni_batches.find { |b| b.first == apply.batch_id }
      next unless alumni_batch
      kitt_camp = kitt_camps.find { |c| c.last == alumni_batch.last }
      next unless kitt_camp
      apply.update_attribute('batch_id', kitt_camp.first)
      kitt_city = kitt_cities.find { |c| c.values.first[:camps].include? kitt_camp.first }
      apply.update_attribute('city_id', kitt_city.values.first[:id])
    end
  end
end
